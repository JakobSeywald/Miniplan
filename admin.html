<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan â€“ Admin</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body { background:#f1f5f9; }
.card { border-radius:14px; }
.mini-row {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
</style>
</head>

<body>
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <span class="navbar-brand">ğŸ•¯ï¸ Miniplan â€“ Admin</span>
  </div>
</nav>

<div class="container my-4">

<ul class="nav nav-pills mb-3">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#minis">Minis</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#godis">Gottesdienste</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#plan">Zuteilung</button></li>
</ul>

<div class="tab-content">

<!-- MINIS -->
<div class="tab-pane fade show active" id="minis">
<div class="card p-3 mb-3">
<textarea id="miniImport" class="form-control" rows="3" placeholder="Max Mustermann"></textarea>
<button class="btn btn-success mt-2" onclick="importMinis()">Importieren</button>
</div>
<div class="card" id="miniList"></div>
</div>

<!-- GODIS -->
<div class="tab-pane fade" id="godis">
<div class="card p-3 mb-3">
<textarea id="godiImport" class="form-control" rows="3"
placeholder="24.12.2024,18:00,Christmette,6,true"></textarea>
<button class="btn btn-primary mt-2" onclick="importGodis()">Importieren</button>
</div>
<div id="godiList"></div>
</div>

<!-- PLAN -->
<div class="tab-pane fade" id="plan">
<div class="card p-4 text-center">
<button class="btn btn-lg btn-primary" onclick="autoAssign()">Automatisch zuteilen</button>
</div>
<div class="card p-3 mt-3" id="planResult"></div>
</div>

</div>
</div>

<!-- SCRIPTS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* ğŸ”¥ FIREBASE â€“ DEINE DATEN */
const firebaseConfig = {
  apiKey: "AIzaSyBxyUvXtwqI9-Jb0iUhUuSgqmbMJMAgzAg",
  authDomain: "miniplan-43d9c.firebaseapp.com",
  projectId: "miniplan-43d9c",
  storageBucket: "miniplan-43d9c.appspot.com",
  messagingSenderId: "284553649544",
  appId: "1:284553649544:web:a96421b904948833b22e3d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------- MINIS -------- */
async function loadMinis() {
  const list = document.getElementById("miniList");
  list.innerHTML = "";
  const snap = await getDocs(collection(db,"minis"));
  snap.forEach(d=>{
    const m=d.data();
    list.innerHTML+=`
      <div class="mini-row">
        ${m.name}
        <button class="btn btn-sm btn-danger" onclick="delMini('${d.id}')">X</button>
      </div>`;
  });
}
window.importMinis = async ()=>{
  const names=document.getElementById("miniImport").value.split("\n").filter(n=>n);
  for(const n of names){
    await setDoc(doc(db,"minis",n.toLowerCase().replace(/\s/g,"_")),{name:n});
  }
  document.getElementById("miniImport").value="";
  loadMinis();
};
window.delMini = async(id)=>{ await deleteDoc(doc(db,"minis",id)); loadMinis(); }

/* -------- GODIS -------- */
window.importGodis = async()=>{
  const lines=document.getElementById("godiImport").value.split("\n").filter(l=>l);
  for(const l of lines){
    const [d,u,a,n,w]=l.split(",").map(s=>s.trim());
    await setDoc(doc(db,"godis",(d+u).replace(/\W/g,"")),{
      datum:d,uhrzeit:u,anlass:a,anzahl:+n,weihrauch:w==="true"
    });
  }
  document.getElementById("godiImport").value="";
  loadGodis();
};
async function loadGodis(){
  const box=document.getElementById("godiList");
  box.innerHTML="";
  const snap=await getDocs(collection(db,"godis"));
  snap.forEach(d=>{
    const g=d.data();
    box.innerHTML+=`<div class="card p-2 mb-2">${g.datum} ${g.uhrzeit} â€“ ${g.anlass}</div>`;
  });
}

/* -------- ZUTEILUNG -------- */
window.autoAssign = async()=>{
  const minis=(await getDocs(collection(db,"minis"))).docs.map(d=>({name:d.data().name,c:0}));
  const godis=(await getDocs(collection(db,"godis"))).docs.map(d=>d.data());
  let out="";
  godis.forEach(g=>{
    minis.sort((a,b)=>a.c-b.c);
    const sel=minis.splice(0,g.anzahl);
    sel.forEach(m=>m.c++);
    out+=`<p><b>${g.datum} ${g.anlass}</b><br>${sel.map(m=>m.name).join(", ")}</p>`;
    minis.push(...sel);
  });
  document.getElementById("planResult").innerHTML=out;
}

loadMinis(); loadGodis();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
