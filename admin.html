<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan Admin Pro</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
:root {
    --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
    --secondary-bg: #f8fafc;
    --accent-color: #6366f1;
}

body { font-family: 'Inter', sans-serif; background-color: var(--secondary-bg); color: #1e293b; }

.navbar-brand { font-weight: 700; letter-spacing: -0.5px; }

.card { 
    border: none; border-radius: 16px; 
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
    transition: all 0.2s ease; margin-bottom: 1.5rem;
}
.card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

.nav-pills .nav-link {
    color: #64748b; font-weight: 600; border-radius: 10px; padding: 10px 20px;
    transition: all 0.3s;
}
.nav-pills .nav-link.active {
    background: var(--primary-gradient); box-shadow: 0 4px 12px rgba(79,70,229,0.3);
}

.form-control { border-radius: 10px; border: 1px solid #e2e8f0; padding: 12px; }
.btn { border-radius: 10px; padding: 10px 20px; font-weight: 600; }
.btn-primary { background: var(--primary-gradient); border: none; }
.btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; }
.btn-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); border: none; }

#pdfPreview { background: white; padding: 40px; border-radius: 10px; min-height: 400px; }

.mini-row {
    display: flex; align-items: center; justify-content: space-between; padding: 12px;
    border-bottom: 1px solid #f1f5f9;
}
.mini-row span { display: flex; align-items: center; gap: 6px; cursor: pointer; }
</style>
</head>
<body>

<!-- Passwort-Login Modal -->
<div class="modal show" tabindex="-1" id="loginModal" style="display:block; background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Admin Login</h5></div>
      <div class="modal-body">
        <input type="password" class="form-control" id="adminPassword" placeholder="Passwort eingeben">
        <div class="text-danger mt-2" id="loginError" style="display:none;">Falsches Passwort</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary w-100" id="loginBtn">Einloggen</button>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4" id="mainNav" style="display:none;">
<div class="container">
<a class="navbar-brand" href="#"><i class="bi bi-person-badge-fill me-2"></i>Miniplan Admin <span class="text-primary">Pro</span></a>
</div>
</nav>

<div class="container" id="adminContent" style="display:none;">
<div id="statusAlert"></div>
<div class="row">

    <!-- Sidebar Tabs -->
    <div class="col-lg-3 mb-4">
        <div class="card p-3">
            <ul class="nav nav-pills flex-column" id="adminTabs" role="tablist">
                <li class="nav-item mb-2">
                    <button class="nav-link active w-100 text-start" data-bs-toggle="tab" data-bs-target="#minis">
                        <i class="bi bi-people me-2"></i> Miniliste
                    </button>
                </li>
                <li class="nav-item mb-2">
                    <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#godis">
                        <i class="bi bi-calendar-event me-2"></i> Gottesdienste
                    </button>
                </li>
                <li class="nav-item mb-2">
                    <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#zuteilung">
                        <i class="bi bi-magic me-2"></i> Zuteilung
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#pdf">
                        <i class="bi bi-file-pdf me-2"></i> PDF Export
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <div class="tab-content">

            <!-- Miniliste -->
            <div class="tab-pane fade show active" id="minis">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="fw-bold m-0">Minis verwalten</h4>
                    <span class="badge bg-primary rounded-pill" id="miniCount">0 Minis</span>
                </div>
                <div class="card p-4 mb-4">
                    <label class="form-label fw-semibold">Schnell-Import (Namen untereinander)</label>
                    <textarea id="minisImport" rows="3" class="form-control mb-3" placeholder="Max Mustermann&#10;Erika Musterfrau"></textarea>
                    <button type="button" class="btn btn-success w-100" id="btnImportMinis">
                        <i class="bi bi-cloud-arrow-up me-2"></i> Liste importieren
                    </button>
                </div>
                <div class="mb-3 position-relative">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                    <input class="form-control ps-5" id="searchMini" placeholder="Suchen...">
                </div>
                <div class="card overflow-hidden">
                    <div id="minisList"></div>
                </div>
            </div>

            <!-- Gottesdienste -->
            <div class="tab-pane fade" id="godis">
                <h4 class="fw-bold mb-4">Gottesdienste planen</h4>
                <div class="card p-4 mb-4 bg-dark text-white">
                    <label class="form-label">Format: Datum, Uhrzeit, Anlass</label>
                    <textarea id="godisImport" rows="3" class="form-control bg-dark text-white mb-3" placeholder="24.12.2023, 18:00, Kinderchristmette"></textarea>
                    <button type="button" class="btn btn-primary w-100" id="btnImportGodis">Dienste hinzufÃ¼gen</button>
                </div>
                <div id="godisList" class="row"></div>
            </div>

            <!-- Zuteilung -->
            <div class="tab-pane fade" id="zuteilung">
                <div class="card p-4 mb-4 bg-white">
                    <h4 class="fw-bold mb-3">Zuteilung berechnen</h4>
                    <div id="zuordnungList"></div>
                </div>
            </div>

            <!-- PDF Export -->
            <div class="tab-pane fade" id="pdf">
                <div class="d-flex justify-content-between mb-4">
                    <h4 class="fw-bold">Vorschau</h4>
                    <button type="button" class="btn btn-dark" id="btnExportPDF">Als PDF speichern</button>
                </div>
                <div id="pdfPreview" class="border"></div>
            </div>

        </div>
    </div>

</div>
</div>

<script type="module">
import { db } from './firebase.js';
import { collection, doc, setDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ----------- Passwort ------------
const ADMIN_PASSWORD = "deinPasswort123";
document.getElementById("loginBtn").onclick = ()=>{
    const pw = document.getElementById("adminPassword").value;
    if(pw===ADMIN_PASSWORD){
        document.getElementById("loginModal").style.display="none";
        document.getElementById("mainNav").style.display="block";
        document.getElementById("adminContent").style.display="block";
        loadMinis();
        loadGodis();
    }else{
        document.getElementById("loginError").style.display="block";
    }
};

// ----------- Status ---------
const showStatus=(msg,type='success')=>{
    const alertDiv=document.getElementById('statusAlert');
    alertDiv.innerHTML=`<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
    setTimeout(()=>{ if(alertDiv.firstChild) alertDiv.firstChild.remove(); },5000);
};

// ----------- Minis -----------
let allMinis=[];
const renderMinis=(minis)=>{
    minis.sort((a,b)=> a.name.split(" ").pop().localeCompare(b.name.split(" ").pop()));
    const container=document.getElementById("minisList");
    container.innerHTML=minis.length===0?'<div class="p-4">Noch keine Minis in der Datenbank.</div>':"";
    minis.forEach(mini=>{
        const div=document.createElement("div");
        div.className="mini-row";
        div.innerHTML=`<span id="mini-${mini.id}"><strong>${mini.name}</strong> <span style="cursor:pointer;" class="mini-weihrauch">${mini.kannWeihrauch? 'ðŸ’¨':'ðŸ’¨'}</span></span>
            <div><button class="btn btn-sm btn-danger" id="del-${mini.id}"><i class="bi bi-trash"></i></button></div>`;
        container.appendChild(div);

        // ðŸ’¨ Klick
        div.querySelector(".mini-weihrauch").onclick = async ()=>{
            mini.kannWeihrauch=!mini.kannWeihrauch;
            await setDoc(doc(db,'minis',mini.id),{kannWeihrauch:mini.kannWeihrauch},{merge:true});
            renderMinis(allMinis);
        };

        document.getElementById(`del-${mini.id}`).onclick = async ()=>{
            if(confirm("LÃ¶schen?")){
                await deleteDoc(doc(db,'minis',mini.id));
                loadMinis();
            }
        };
    });
};
const loadMinis=async()=>{
    const snap=await getDocs(collection(db,'minis'));
    allMinis=snap.docs.map(d=>({id:d.id,...d.data()}));
    document.getElementById("miniCount").innerText=`${allMinis.length} Minis`;
    renderMinis(allMinis);
};
document.getElementById("btnImportMinis").onclick=async()=>{
    const names=document.getElementById("minisImport").value.split("\n").map(n=>n.trim()).filter(n=>n);
    if(names.length===0) return;
    for(const name of names){
        const id=name.replace(/[^a-z0-9]/gi,'_').toLowerCase();
        await setDoc(doc(db,'minis',id),{name,kannWeihrauch:false},{merge:true});
    }
    document.getElementById("minisImport").value="";
    showStatus(`${names.length} Minis importiert.`);
    loadMinis();
};
document.getElementById("searchMini").oninput=(e)=>renderMinis(allMinis.filter(m=>m.name.toLowerCase().includes(e.target.value.toLowerCase())));

// ----------- Gottesdienste ----------
let allGodis=[];
const loadGodis=async()=>{
    const snap=await getDocs(collection(db,'godis'));
    allGodis=snap.docs.map(d=>({id:d.id,...d.data()}));
    allGodis.sort((a,b)=>a.datum.localeCompare(b.datum) || a.uhrzeit.localeCompare(b.uhrzeit));
    const container=document.getElementById("godisList");
    container.innerHTML="";
    allGodis.forEach(g=>{
        const div=document.createElement("div");
        div.className="col-md-6 mb-3";
        div.innerHTML=`<div class="card p-3 border-start border-4 border-primary shadow-sm">
            <div class="fw-bold">${g.anlass}</div>
            <div class="small">${g.datum} | ${g.uhrzeit}</div>
        </div>`;
        container.appendChild(div);
    });
};
document.getElementById("btnImportGodis").onclick=async()=>{
    const lines=document.getElementById("godisImport").value.split("\n").filter(l=>l.trim());
    for(const line of lines){
        const [datum,uhrzeit,anlass]=line.split(",").map(s=>s.trim());
        const id=(datum+uhrzeit).replace(/\W/g,'');
        await setDoc(doc(db,'godis',id),{datum,uhrzeit,anlass});
    }
    document.getElementById("godisImport").value="";
    showStatus("Dienste importiert.");
    loadGodis();
};

// ----------- PDF Export ----------
document.getElementById("btnExportPDF").onclick=()=>{
    import("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js").then(h=>{
        h.default().from(document.getElementById("pdfPreview")).save("Miniplan.pdf");
    });
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
