<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; font-family:sans-serif;}
.card { margin-bottom:10px; padding:10px; }
.weihrauch { border-left: 4px solid gold; }
.btn-publish { background-color: #28a745; color:white; margin-right:5px; }
.btn-withdraw { background-color: #6c757d; color:white; }
</style>
</head>
<body>

<h2>Admin Miniplan</h2>

<div id="adminUI">

<h4>Minis verwalten</h4>
<textarea id="minisImport" rows="4" class="form-control" placeholder="Liste einfügen (ein Name pro Zeile)"></textarea>
<button class="btn btn-success mt-2" onclick="importMinis()">Importieren / Aktualisieren</button>
<div id="minisList"></div>

<hr>
<h4>Gottesdienste verwalten</h4>
<textarea id="godisImport" rows="4" class="form-control" placeholder="Liste: Datum, Uhrzeit, Anlass, Anzahl, Weihrauch (true/false)"></textarea>
<button class="btn btn-success mt-2" onclick="importGodis()">Importieren / Aktualisieren</button>
<div id="godisList"></div>

<hr>
<h4>Frist & Veröffentlichung</h4>
<input type="datetime-local" id="fristInput" class="form-control mb-2">
<button class="btn btn-publish" onclick="veroeffentlichen()">Veröffentlichen</button>
<button class="btn btn-withdraw" onclick="zurueckziehen()">Zurückziehen</button>

<hr>
<h4>Automatische Zuteilung</h4>
<button class="btn btn-primary" onclick="automatischeZuteilung()">Jetzt zuordnen</button>
<div id="zuordnungList"></div>

<hr>
<h4>PDF Export</h4>
<button class="btn btn-secondary" onclick="exportPDF()">Plan exportieren</button>

</div>

<script type="module">
import { db } from './firebase.js';
import { collection, doc, setDoc, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// --- Minis verwalten ---
async function importMinis(){
    const lines = document.getElementById("minisImport").value.split("\n").map(s=>s.trim()).filter(s=>s);
    for(let l of lines){
        const docRef = doc(db,'minis',l);
        await setDoc(docRef,{name:l,kannWeihrauch:false,geschwister:[],verfuegbarAn:[]});
    }
    loadMinis();
}

async function loadMinis(){
    const minisCol = collection(db,'minis');
    const minisSnap = await getDocs(minisCol);
    const container = document.getElementById("minisList");
    container.innerHTML = "";
    minisSnap.forEach(doc=>{
        const mini = doc.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <input type="text" value="${mini.name}" onchange="updateMini('${doc.id}',this.value)">
          <label><input type="checkbox" onchange="toggleWeihrauch('${doc.id}',this.checked)"> Weihrauch</label>
        `;
        container.appendChild(div);
    });
}

async function updateMini(id,newName){
    const docRef = doc(db,'minis',id);
    await updateDoc(docRef,{name:newName});
}

async function toggleWeihrauch(id,value){
    const docRef = doc(db,'minis',id);
    await updateDoc(docRef,{kannWeihrauch:value});
}

// --- Godis verwalten ---
async function importGodis(){
    const lines = document.getElementById("godisImport").value.split("\n").map(s=>s.trim()).filter(s=>s);
    for(let l of lines){
        const [datum,uhrzeit,anlass,minAnzahl,weihrauch] = l.split(",");
        const docRef = doc(db,'godis',datum+"_"+uhrzeit);
        await setDoc(docRef,{
            datum, uhrzeit, anlass, minAnzahl:parseInt(minAnzahl), weihrauch:weihrauch==="true", veroeffentlicht:false
        });
    }
    loadGodis();
}

async function loadGodis(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    const container = document.getElementById("godisList");
    container.innerHTML="";
    godisSnap.forEach(doc=>{
        const g = doc.data();
        const div = document.createElement("div");
        div.className = "card"+(g.weihrauch?" weihrauch":"");
        div.innerHTML = `<b>${g.datum} ${g.uhrzeit}</b> - ${g.anlass} - ${g.minAnzahl} Minis - Weihrauch: ${g.weihrauch}`;
        container.appendChild(div);
    });
}

// --- Veröffentlichung ---
async function veroeffentlichen(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    for(let docSnap of godisSnap.docs){
        const docRef = doc(db,'godis',docSnap.id);
        await updateDoc(docRef,{veroeffentlicht:true});
    }
    alert("Gottesdienste veröffentlicht");
    loadGodis();
}

async function zurueckziehen(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    for(let docSnap of godisSnap.docs){
        const docRef = doc(db,'godis',docSnap.id);
        await updateDoc(docRef,{veroeffentlicht:false});
    }
    alert("Gottesdienste zurückgezogen");
    loadGodis();
}

// --- Automatische Zuteilung ---
async function automatischeZuteilung(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    const minisCol = collection(db,'minis');
    const minisSnap = await getDocs(minisCol);
    const minis = minisSnap.docs.map(d=>({id:d.id,...d.data(), count:0}));
    let output = "";
    
    for(let docSnap of godisSnap.docs){
        const g = docSnap.data();
        if(!g.veroeffentlicht) continue;
        const assigned = [];
        
        // 1) Wähle zuerst 2 für Weihrauch, falls benötigt
        if(g.weihrauch){
            let available = minis.filter(m=>!assigned.includes(m.id));
            available.sort((a,b)=>a.count-b.count);
            for(let i=0;i<2 && i<available.length;i++){
                assigned.push(available[i].id);
                available[i].count++;
            }
        }
        
        // 2) Restliche Minis
        let needed = g.minAnzahl - assigned.length;
        if(needed>0){
            let available = minis.filter(m=>!assigned.includes(m.id));
            available.sort((a,b)=>a.count-b.count);
            for(let i=0;i<needed && i<available.length;i++){
                assigned.push(available[i].id);
                available[i].count++;
            }
        }
        
        output+=`<div class="card">${g.datum} ${g.uhrzeit} - ${g.anlass}: ${assigned.map(a=>minis.find(m=>m.id===a).name).join(", ")}</div>`;
    }
    
    document.getElementById("zuordnungList").innerHTML = output;
}

// --- PDF Export ---
function exportPDF(){
    const element = document.getElementById("zuordnungList");
    import("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js").then(html2pdf=>{
        html2pdf.default().from(element).save("Miniplan.pdf");
    });
}

// --- Init ---
loadMinis();
loadGodis();
</script>

</body>
</html>
