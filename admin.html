<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan Admin</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding: 20px; font-family: sans-serif; }
.card { margin-bottom: 10px; }
.btn-publish { background-color: #28a745; color: white; }
.btn-withdraw { background-color: #6c757d; color: white; }
.weihrauch { border-left: 4px solid gold; }
</style>
</head>
<body>

<h2>Admin Miniplan</h2>
<label>Admin-Passwort: <input type="password" id="adminPassword" placeholder="Passwort"></label>
<button class="btn btn-primary" onclick="login()">Login</button>
<hr>

<div id="adminUI" style="display:none;">

<h4>Minis verwalten</h4>
<textarea id="minisImport" rows="4" class="form-control" placeholder="Liste einfügen (ein Name pro Zeile)"></textarea>
<button class="btn btn-success mt-2" onclick="importMinis()">Importieren / Aktualisieren</button>
<div id="minisList"></div>

<hr>
<h4>Gottesdienste verwalten</h4>
<textarea id="godisImport" rows="4" class="form-control" placeholder="Liste: Datum, Uhrzeit, Anlass, Anzahl, Weihrauch (true/false)"></textarea>
<button class="btn btn-success mt-2" onclick="importGodis()">Importieren / Aktualisieren</button>
<div id="godisList"></div>

<hr>
<h4>Frist & Veröffentlichung</h4>
<input type="datetime-local" id="fristInput">
<button class="btn btn-publish" onclick="veroeffentlichen()">Veröffentlichen</button>
<button class="btn btn-withdraw" onclick="zurueckziehen()">Zurückziehen</button>

<hr>
<h4>Automatische Zuteilung</h4>
<button class="btn btn-primary" onclick="automatischeZuteilung()">Jetzt zuordnen</button>
<div id="zuordnungList"></div>

<hr>
<h4>PDF Export</h4>
<button class="btn btn-secondary" onclick="exportPDF()">Plan exportieren</button>

</div>

<script type="module">
import { db } from './firebase.js';
import { collection, doc, setDoc, getDocs, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let loggedIn = false;
const ADMIN_PASSWORD = "miniplan"; // hier ändern

function login() {
    const pw = document.getElementById("adminPassword").value;
    if(pw === ADMIN_PASSWORD){
        loggedIn = true;
        document.getElementById("adminUI").style.display = "block";
        alert("Login erfolgreich");
        loadMinis();
        loadGodis();
    } else {
        alert("Falsches Passwort");
    }
}

// --- Minis verwalten ---
async function importMinis(){
    if(!loggedIn) return;
    const lines = document.getElementById("minisImport").value.split("\n").map(s=>s.trim()).filter(s=>s);
    const batch = collection(db,'minis');
    for(let l of lines){
        const docRef = doc(db,'minis',l);
        await setDoc(docRef,{name:l,kannWeihrauch:false,geschwister:[],verfuegbarAn:[]});
    }
    loadMinis();
}

async function loadMinis(){
    const minisCol = collection(db,'minis');
    const minisSnap = await getDocs(minisCol);
    const container = document.getElementById("minisList");
    container.innerHTML = "";
    minisSnap.forEach(doc=>{
        const mini = doc.data();
        const div = document.createElement("div");
        div.className = "card p-2";
        div.innerHTML = `<input type="text" value="${mini.name}" onchange="updateMini('${doc.id}',this.value)">`;
        container.appendChild(div);
    });
}

async function updateMini(id,newName){
    const docRef = doc(db,'minis',id);
    await updateDoc(docRef,{name:newName});
}

// --- Godis verwalten ---
async function importGodis(){
    if(!loggedIn) return;
    const lines = document.getElementById("godisImport").value.split("\n").map(s=>s.trim()).filter(s=>s);
    for(let l of lines){
        const [datum,uhrzeit,anlass,minAnzahl,weihrauch] = l.split(",");
        const docRef = doc(db,'godis',datum+"_"+uhrzeit);
        await setDoc(docRef,{
            datum, uhrzeit, anlass, minAnzahl:parseInt(minAnzahl), weihrauch:weihrauch==="true", veroeffentlicht:false
        });
    }
    loadGodis();
}

async function loadGodis(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    const container = document.getElementById("godisList");
    container.innerHTML="";
    godisSnap.forEach(doc=>{
        const g = doc.data();
        const div = document.createElement("div");
        div.className = "card p-2";
        div.innerHTML = `<b>${g.datum} ${g.uhrzeit}</b> - ${g.anlass} - ${g.minAnzahl} Minis - Weihrauch: ${g.weihrauch}`;
        container.appendChild(div);
    });
}

// --- Veröffentlichung ---
async function veroeffentlichen(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    for(let docSnap of godisSnap.docs){
        const docRef = doc(db,'godis',docSnap.id);
        await updateDoc(docRef,{veroeffentlicht:true});
    }
    alert("Gottesdienste veröffentlicht");
}

async function zurueckziehen(){
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    for(let docSnap of godisSnap.docs){
        const docRef = doc(db,'godis',docSnap.id);
        await updateDoc(docRef,{veroeffentlicht:false});
    }
    alert("Gottesdienste zurückgezogen");
}

// --- Automatische Zuteilung (vereinfacht) ---
async function automatischeZuteilung(){
    alert("Automatische Zuteilung startet (Geschwister, Weihrauch, fair verteilt)");
    // Logik hier einfügen (siehe vorherige Struktur)
    document.getElementById("zuordnungList").innerHTML="Zuteilung durchgeführt (Placeholder)";
}

// --- PDF Export ---
function exportPDF(){
    alert("PDF Export wird vorbereitet (kann z.B. jsPDF verwenden)");
}
</script>

</body>
</html>
