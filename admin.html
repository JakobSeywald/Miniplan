<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan Admin Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
:root { --primary-gradient: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); --secondary-bg: #f8fafc; --accent-color: #6366f1; }
body { background-color: var(--secondary-bg); font-family: 'Inter', sans-serif; color: #1e293b; }
.navbar-brand { font-weight: 700; letter-spacing: -0.5px; }
.card { border: none; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1); transition: all 0.2s ease; margin-bottom: 1.5rem; }
.card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
.nav-pills .nav-link { color: #64748b; font-weight: 600; border-radius: 10px; padding: 10px 20px; transition: all 0.3s; }
.nav-pills .nav-link.active { background: var(--primary-gradient); box-shadow: 0 4px 12px rgba(79,70,229,0.3); }
.form-control { border-radius: 10px; border: 1px solid #e2e8f0; padding: 12px; }
.btn { border-radius: 10px; padding: 10px 20px; font-weight: 600; }
.btn-primary { background: var(--primary-gradient); border: none; }
.btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; }
.badge-smoke { background-color: #fef3c7; color: #d97706; font-size: 0.75rem; padding: 5px 10px; border-radius: 20px; }
#pdfPreview { background: white; padding: 40px; border-radius: 10px; min-height: 400px; }
.mini-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; }
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container">
    <a class="navbar-brand" href="#"><i class="bi bi-person-badge-fill me-2"></i>Miniplan Admin <span class="text-primary">Pro</span></a>
  </div>
</nav>

<div class="container">
  <div id="statusAlert"></div>
  <div class="row">
    <div class="col-lg-3 mb-4">
      <div class="card p-3">
        <ul class="nav nav-pills flex-column" id="adminTabs" role="tablist">
          <li class="nav-item mb-2">
            <button class="nav-link active w-100 text-start" data-bs-toggle="tab" data-bs-target="#minis">
              <i class="bi bi-people me-2"></i> Miniliste
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#godis">
              <i class="bi bi-calendar-event me-2"></i> Gottesdienste
            </button>
          </li>
          <li class="nav-item mb-2">
            <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#zuteilung">
              <i class="bi bi-magic me-2"></i> Zuteilung
            </button>
          </li>
          <li class="nav-item">
            <button class="nav-link w-100 text-start" data-bs-toggle="tab" data-bs-target="#pdf">
              <i class="bi bi-file-pdf me-2"></i> PDF Export
            </button>
          </li>
        </ul>
      </div>
    </div>

    <div class="col-lg-9">
      <div class="tab-content">
        <div class="tab-pane fade show active" id="minis">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="fw-bold m-0">Minis verwalten</h4>
            <span class="badge bg-primary rounded-pill" id="miniCount">0 Minis</span>
          </div>
          <div class="card p-4 mb-4">
            <label class="form-label fw-semibold">Schnell-Import (Namen untereinander)</label>
            <textarea id="minisImport" rows="3" class="form-control mb-3" placeholder="Max Mustermann&#10;Erika Musterfrau"></textarea>
            <button type="button" class="btn btn-success w-100" id="btnImportMinis">
              <i class="bi bi-cloud-arrow-up me-2"></i> Liste importieren
            </button>
          </div>
          <div class="mb-3 position-relative">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            <input class="form-control ps-5" id="searchMini" placeholder="Suchen...">
          </div>
          <div class="card overflow-hidden">
            <div id="minisList"></div>
          </div>
        </div>

        <div class="tab-pane fade" id="godis">
          <h4 class="fw-bold mb-4">Gottesdienste planen</h4>
          <div class="card p-4 mb-4 bg-dark text-white">
            <label class="form-label">Format: Datum, Uhrzeit, Anlass, Anzahl, Weihrauch (true/false)</label>
            <textarea id="godisImport" rows="3" class="form-control bg-dark text-white mb-3" placeholder="24.12.2023, 18:00, Kinderchristmette, 6, false"></textarea>
            <button type="button" class="btn btn-primary w-100" id="btnImportGodis">Dienste hinzufÃ¼gen</button>
          </div>
          <div id="godisList" class="row"></div>
        </div>

        <div class="tab-pane fade" id="zuteilung">
          <div class="card p-5 text-center bg-white">
            <h4 class="fw-bold">Zuteilung berechnen</h4>
            <button type="button" class="btn btn-primary btn-lg mt-3" id="btnAutoAssign">Zuteilung starten</button>
          </div>
          <div id="zuordnungList" class="mt-4"></div>
        </div>

        <div class="tab-pane fade" id="pdf">
          <div class="d-flex justify-content-between mb-4">
            <h4 class="fw-bold">Vorschau</h4>
            <button type="button" class="btn btn-dark" id="btnExportPDF">Als PDF speichern</button>
          </div>
          <div id="pdfPreview" class="border"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { db } from "./firebase.js"; // DEINE EXISTIERENDE firebase.js
import { collection, doc, setDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let allMinis = [];

const showStatus = (msg,type='success')=>{
  const a=document.getElementById('statusAlert');
  a.innerHTML=`<div class="alert alert-${type} alert-dismissible fade show">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  setTimeout(()=>{ if(a.firstChild) a.firstChild.remove();},5000);
};

const loadMinis = async()=>{
  const snap=await getDocs(collection(db,'minis'));
  allMinis=snap.docs.map(d=>({id:d.id,...d.data()}));
  document.getElementById("miniCount").innerText=`${allMinis.length} Minis`;
  renderMinis(allMinis);
};

const renderMinis = (minis)=>{
  const c=document.getElementById("minisList");
  c.innerHTML=minis.length===0?'<div class="p-4">Noch keine Minis in der Datenbank.</div>':"";
  minis.forEach(m=>{
    const div=document.createElement("div");
    div.className="mini-row";
    div.innerHTML=`<span><strong>${m.name}</strong></span>
      <div>
        <input type="checkbox" ${m.kannWeihrauch?'checked':''} id="wr-${m.id}" class="form-check-input">
        <label class="small me-3">Weihrauch</label>
        <button class="btn btn-sm btn-outline-danger" id="del-${m.id}"><i class="bi bi-trash"></i></button>
      </div>`;
    c.appendChild(div);
    document.getElementById(`wr-${m.id}`).onchange=e=>updateDoc(doc(db,'minis',m.id),{kannWeihrauch:e.target.checked});
    document.getElementById(`del-${m.id}`).onclick=async()=>{if(confirm("LÃ¶schen?")){await deleteDoc(doc(db,'minis',m.id)); loadMinis();}};
  });
};

const importMinis = async()=>{
  const names=document.getElementById("minisImport").value.split("\n").map(n=>n.trim()).filter(n=>n);
  for(const n of names){
    const id=n.replace(/[^a-z0-9]/gi,'_').toLowerCase();
    await setDoc(doc(db,'minis',id),{name:n,kannWeihrauch:false},{merge:true});
  }
  document.getElementById("minisImport").value="";
  showStatus(`${names.length} Minis importiert.`);
  await loadMinis();
};

const loadGodis = async()=>{
  const snap=await getDocs(collection(db,'godis'));
  const c=document.getElementById("godisList");
  c.innerHTML="";
  snap.forEach(d=>{
    const g=d.data();
    const div=document.createElement("div");
    div.className="col-md-6 mb-3";
    div.innerHTML=`<div class="card p-3 border-start border-4 border-primary shadow-sm">
      <div class="fw-bold">${g.anlass} ${g.weihrauch?'ðŸ”¥':''}</div>
      <div class="small">${g.datum} | ${g.uhrzeit} Uhr</div>
      <div class="mt-2 text-primary small">Bedarf: ${g.minAnzahl} Minis</div>
    </div>`;
    c.appendChild(div);
  });
};

const importGodis = async()=>{
  const lines=document.getElementById("godisImport").value.split("\n").filter(l=>l.trim());
  for(const l of lines){
    const [datum,uhrzeit,anlass,anz,wr]=l.split(",").map(s=>s.trim());
    const id=(datum+uhrzeit).replace(/\W/g,'');
    await setDoc(doc(db,'godis',id),{datum,uhrzeit,anlass,minAnzahl:+anz,weihrauch:wr==='true'});
  }
  document.getElementById("godisImport").value="";
  showStatus("Dienste importiert.");
  loadGodis();
};

const autoAssign = async()=>{
  const godisSnap=await getDocs(collection(db,'godis'));
  let minis=[...allMinis].map(m=>({...m,count:0}));
  if(minis.length===0) return showStatus("Keine Minis!",'warning');
  let html=`<table class="table table-bordered bg-white"><thead><tr><th>Tag</th><th>Anlass</th><th>Minis</th></tr></thead><tbody>`;
  const sortedGodis=godisSnap.docs.map(d=>d.data()).sort((a,b)=>a.datum.localeCompare(b.datum));
  sortedGodis.forEach(g=>{
    let assigned=[];
    if(g.weihrauch){
      const wr=minis.filter(m=>m.kannWeihrauch && !assigned.includes(m.name)).sort((a,b)=>a.count-b.count);
      for(let i=0;i<2 && i<wr.length;i++){
        assigned.push(wr[i].name);
        minis.find(m=>m.id===wr[i].id).count++;
      }
    }
    const others=minis.filter(m=>!assigned.includes(m.name)).sort((a,b)=>a.count-b.count);
    while(assigned.length<g.minAnzahl && others.length>0){
      const pick=others.shift();
      assigned.push(pick.name);
      minis.find(m=>m.id===pick.id).count++;
    }
    html+=`<tr><td>${g.datum}<br>${g.uhrzeit}</td><td>${g.anlass}</td><td>${assigned.join(", ")}</td></tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById("zuordnungList").innerHTML=html;
  document.getElementById("pdfPreview").innerHTML=html;
};

document.getElementById("btnImportMinis").onclick=importMinis;
document.getElementById("btnImportGodis").onclick=importGodis;
document.getElementById("btnAutoAssign").onclick=autoAssign;
document.getElementById("searchMini").oninput=e=>renderMinis(allMinis.filter(m=>m.name.toLowerCase().includes(e.target.value.toLowerCase())));
document.getElementById("btnExportPDF").onclick=()=>import("https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js").then(h=>{h.default().from(document.getElementById("pdfPreview")).save("Plan.pdf");});

loadMinis();
loadGodis();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
