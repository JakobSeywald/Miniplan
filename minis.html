<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miniplan Minis</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { padding:20px; font-family:sans-serif;}
.card { margin-bottom:10px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
.xbtn { color:red; font-weight:bold; font-size:1.5em; cursor:pointer; }
.xbtn.active { color:darkred; }
.weihrauch { border-left:4px solid gold; padding-left:5px;}
</style>
</head>
<body>

<h2>Miniplan Abmeldung</h2>
<label>Dein Name: <input type="text" id="miniName"></label>
<button class="btn btn-primary" onclick="loadGodis()">Los</button>

<div id="godisContainer"></div>
<button class="btn btn-success mt-2" onclick="speichern()">Speichern</button>

<script type="module">
import { db } from './firebase.js';
import { collection, doc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

let aktuelleAbmeldungen = {};

async function loadGodis(){
    const name = document.getElementById("miniName").value.trim();
    if(!name){ alert("Bitte Namen eingeben"); return; }
    aktuelleAbmeldungen[name]={};
    const godisCol = collection(db,'godis');
    const godisSnap = await getDocs(godisCol);
    const container = document.getElementById("godisContainer");
    container.innerHTML="";
    godisSnap.forEach(docSnap=>{
        const g = docSnap.data();
        if(!g.veroeffentlicht) return;
        const card = document.createElement("div");
        card.className = "card"+(g.weihrauch?" weihrauch":"");
        card.title = "Klicke X, wenn du nicht teilnehmen kannst";
        const html = `<div>${g.uhrzeit} ${g.datum} - ${g.anlass}</div>
                      <div class="xbtn" onclick="toggleX(this,'${name}','${docSnap.id}')">X</div>`;
        card.innerHTML = html;
        container.appendChild(card);
    });
}

function toggleX(elem,name,godiID){
    elem.classList.toggle("active");
    aktuelleAbmeldungen[name][godiID] = elem.classList.contains("active")?"nein":"ja";
}

async function speichern(){
    for(let mini in aktuelleAbmeldungen){
        for(let godiID in aktuelleAbmeldungen[mini]){
            if(aktuelleAbmeldungen[mini][godiID]==="nein"){
                const docRef = doc(db,'abmeldungen',mini+"_"+godiID);
                await setDoc(docRef,{mini, godi:godiID, status:"nein"});
            }
        }
    }
    alert("Abmeldungen gespeichert");
}
</script>

</body>
</html>
